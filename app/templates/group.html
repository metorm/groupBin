{% extends "base.html" %}

{% from "_upload_form.html" import render_upload_form %}

{% block title %}{{ group.name or group.id }} - GroupBin{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1>{{ group.name or group.id }}</h1>
        <p class="text-muted">小组ID: {{ group.id }}</p>
        <p class="text-muted">创建者: {{ group.creator or '匿名' }}</p>
    </div>
    <div class="text-end">
        <p class="text-danger expiration-time" data-expires-at="{{ group.expires_at.isoformat() }}"></p>
        <a href="{{ url_for('group.refresh', group_id=group.id) }}" class="btn btn-sm btn-outline-secondary">刷新有效期</a>
    </div>

    {% if group.allow_convert_to_readonly and not group.is_readonly %}
    <div class="mb-3">
        <button id="convertToReadonlyBtn" class="btn btn-warning">转为只读小组</button>
    </div>
    {% endif %}
</div>

{% if not group.is_readonly %}
<div class="card mb-4">
    <div class="card-header">
        <h2>上传文件</h2>
    </div>
    <div class="card-body">
        {{ render_upload_form(
            action_url=url_for('file.upload', group_id=group.id),
            button_text='上传文件',
            allow_multiple=true,
            show_uploader=true,
            show_description=true,
            show_comment=true,
            group_id=group.id
        ) }}
    </div>
</div>
{% endif %}

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h2>文件列表</h2>
        <a href="{{ url_for('file.zip_download', group_id=group.id) }}" class="btn btn-outline-primary">打包下载所有文件</a>
    </div>
    <div class="card-body">
        {% if group.files %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>文件名</th>
                        <th>大小</th>
                        <th>上传时间</th>
                        <th>上传者</th>
                        <th>版本</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in group.files %}
                    <tr>
                        <td class="align-middle">
                            <div class="file-info">
                                <strong>{{ file.original_filename }}</strong>
                                {% if file.description %}
                                <small class="d-block text-muted">{{ file.description }}</small>
                                {% endif %}
                            </div>
                        </td>
                        <td class="align-middle">{{ (file.size / 1024)|round(2) }} KB</td>
                        <td class="align-middle">
                            <span class="utc-time" data-utc="{{ file.uploaded_at.isoformat() }}Z">{{
                                file.uploaded_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        </td>
                        <td class="align-middle">{{ file.versions[-1].uploader or '匿名' }}</td>
                        <td class="align-middle">{{ file.versions|length }}</td>
                        <td class="align-middle">
                            <!-- 独立按钮设计，移除按钮组容器 -->
                            <a href="{{ url_for('file.download', group_id=group.id, file_id=file.id) }}"
                                class="btn btn-primary btn-lg me-2">下载</a>
                            <a href="{{ url_for('file.version_history', group_id=group.id, file_id=file.id) }}"
                                class="btn btn-secondary btn-lg me-2">版本历史</a>

                            {% if not group.is_readonly %}
                            <form method="POST"
                                action="{{ url_for('file.delete_file', group_id=group.id, file_id=file.id) }}"
                                class="d-inline">
                                <input type="hidden" name="_method" value="DELETE">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="btn btn-danger btn-lg"
                                    onclick="return confirm('确定要删除这个文件吗？');">删除</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            该小组暂无文件，上传您的第一个文件吧！
        </div>
        {% endif %}
    </div>
</div>

<script type="module" src="{{ url_for('static', filename='js/group.js') }}"></script>
<script src="{{ url_for('static', filename='js/historyManager.js') }}"></script>
<script>
    // 页面加载完成后更新小组访问记录
    document.addEventListener('DOMContentLoaded', function () {
        // 获取当前小组信息
        const groupInfo = {
            id: '{{ group.id }}',
            name: '{{ group.name or group.id }}',
            expiresAt: '{{ group.expires_at.isoformat() }}'
        };

        // 更新访问历史
        GroupHistoryManager.updateHistory(groupInfo);
    });
</script>


<script>
    document.getElementById('convertToReadonlyBtn')?.addEventListener('click', async function () {
        if (confirm('确定要将小组转为只读状态吗？此操作不可逆转！')) {
            try {
                const response = await fetch("{{ url_for('group.convert_to_readonly', group_id=group.id) }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    alert('小组已成功转为只读状态');
                    window.location.reload();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('转换失败:', error);
                alert('转换失败，请重试');
            }
        }
    });
</script>

{% endblock %}