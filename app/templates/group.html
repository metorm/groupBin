{% extends "base.html" %}

{% from "_upload_form.html" import render_upload_form %}

{% block title %}{{ group.name or group.id }} - GroupBin{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1>{{ group.name or group.id }}</h1>
        <p class="text-muted mb-1">小组ID: {{ group.id }}</p>
        <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
            <p class="text-muted mb-0 me-3">创建者: {{ group.creator or '匿名' }}</p>
            <button class="btn btn-sm btn-outline-primary" id="copy-link-btn">
                <i class="bi bi-link"></i> 复制页面地址
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="copy-id-btn" data-toggle="tooltip"
                title="通过公共信道仅发送小组ID，不含网址更安全">
                <i class="bi bi-clipboard"></i> 复制小组ID
            </button>
            {% if group.allow_convert_to_readonly and not group.is_readonly %}
            <button id="convertToReadonlyBtn" class="btn btn-sm btn-warning">转为只读小组</button>
            {% endif %}
        </div>
    </div>
    <div class="text-end">
        <p class="text-danger expiration-time" data-expires-at="{{ group.expires_at.isoformat() }}"></p>
        <a href="{{ url_for('group.refresh', group_id=group.id) }}" class="btn btn-sm btn-outline-secondary">刷新有效期</a>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4>文件列表</h4>
        <span class="badge bg-secondary">{{ group.files|length }} 个文件</span>
    </div>
    <div class="card-body">
        {% if group.files %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th class="text-nowrap">文件名</th>
                        <th class="text-nowrap">大小</th>
                        <th class="text-nowrap">上传时间</th>
                        <th class="text-nowrap">上传者</th>
                        <th class="text-nowrap">版本</th>
                        <th class="text-nowrap">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in group.files %}
                    <tr>
                        <td class="align-middle">
                            <div class="file-info">
                                <div class="file-name-wrap">
                                    <a href="{{ url_for('file.download', group_id=group.id, file_id=file.id) }}"
                                        class="file-download-link" style="text-decoration: none;">
                                        <strong class="text-primary">{{ file.original_filename }}</strong>
                                    </a>
                                </div>
                                {% if file.description %}
                                <div class="file-description-wrap">
                                    <small class="text-muted">{{ file.description }}</small>
                                </div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="align-middle file-size" data-size="{{ file.versions[-1].size }}">-</td>
                        <td class="align-middle">
                            <span class="utc-time" data-utc="{{ file.versions[-1].uploaded_at.isoformat() }}Z">{{
                                file.versions[-1].uploaded_at.strftime('%m-%d %H:%M') }}</span>
                        </td>
                        <td class="align-middle">{{ file.versions[-1].uploader or '匿名' }}</td>
                        <td class="align-middle">{{ file.versions|length }}</td>
                        <td class="align-middle">
                            <!-- 独立按钮设计，移除按钮组容器 -->
                            <div class="d-flex flex-column gap-1">
                                <a href="{{ url_for('file.version_history', group_id=group.id, file_id=file.id) }}"
                                    class="btn btn-primary btn-sm text-nowrap">版本</a>

                                {% if not group.is_readonly %}
                                <form method="POST"
                                    action="{{ url_for('file.delete_file', group_id=group.id, file_id=file.id) }}"
                                    class="d-inline delete-form">
                                    <input type="hidden" name="_method" value="DELETE">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-danger btn-sm w-100 text-nowrap"
                                        onclick="return confirm('确定要删除这个文件吗？');">删除</button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 当前小组中没有文件，请上传文件
        </div>
        {% endif %}
    </div>
</div>

{% if not group.is_readonly %}
<div class="card">
    <div class="card-header">
        <h4>上传文件</h4>
    </div>
    <div class="card-body">
        {{ render_upload_form(
            action_url=url_for('file.upload', group_id=group.id),
            button_text='上传文件',
            allow_multiple=true,
            show_uploader=true,
            default_uploader=group.creator or '',
            show_description=true,
            show_comment=false,
            group_id=group.id
        ) }}
    </div>
</div>
{% endif %}

<script src="{{ url_for('static', filename='js/groupbin.js') }}"></script>
<script>
    // 格式化页面上的文件大小显示
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.file-size').forEach(function(element) {
            const size = parseInt(element.getAttribute('data-size'));
            if (!isNaN(size)) {
                element.textContent = formatFileSize(size);
            }
        });
    });
</script>

{% endblock %}