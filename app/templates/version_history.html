{% extends "base.html" %}
{% from "_upload_form.html" import render_upload_form %}

{% block title %}{{ file.original_filename }} - 版本历史管理 - GroupBin{% endblock %}

{% block content %}

<h2>{{ file.original_filename }} 的版本历史</h2>
<p class="text-muted">共 {{ versions|length }} 个版本</p>

{% if not group.is_readonly %}
<div class="card mb-4">
    <div class="card-header">
        <h4>上传新版本</h4>
    </div>
    <div class="card-body">
        {{ render_upload_form(
        action_url=url_for('file.upload_version', group_id=group.id, file_id=file.id),
        button_text='上传新版本',
        allow_multiple=false,
        show_uploader=true,
        show_description=false,
        show_comment=true,
        group_id=group.id,
        file_id=file.id
        ) }}
    </div>
</div>
{% endif %}

<table class="table table-striped mt-3">
    <thead>
        <tr>
            <th>版本</th>
            <th>上传时间</th>
            <th>上传者</th>
            <th>版本说明</th>
            <th>大小</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for version in versions %}
        <tr>
            <td>v{{ loop.revindex }}</td>
            <td>
                <span class="utc-time" data-utc="{{ version.uploaded_at.isoformat() }}Z">{{
                    version.uploaded_at.strftime('%m-%d %H:%M') }}</span>
            </td>
            <td>{{ version.uploader }}</td>
            <td>{{ version.comment }}</td>
            <td class="file-size" data-size="{{ version.size }}">-</td>
            <td>
                <div class="d-flex flex-column gap-1">
                    <a href="{{ url_for('file.download_version', group_id=group.id, file_id=file.id, version_id=version.id) }}"
                        class="btn btn-sm btn-primary">下载</a>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<a href="{{ url_for('group.view', group_id=group.id) }}" class="btn btn-secondary">返回小组</a>

<script src="{{ url_for('static', filename='js/groupbin.js') }}"></script>

<script>
    // 格式化页面上的文件大小显示
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.file-size').forEach(function(element) {
            const size = parseInt(element.getAttribute('data-size'));
            if (!isNaN(size)) {
                element.textContent = formatFileSize(size);
            }
        });
    });
</script>

{% endblock %}
