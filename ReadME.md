# groupBin

一个用于小组的 pastebin 类似项目。

其功能类似于 pastebin，但文件共享以临时生成的“小组”为单位，每一个小组有一个独特的链接，该链接可以分享给小组的成员。在小组存续期内，可以从链接中进行文件的上传、下载、更新。

# 功能定义

## 小组

一个小组是一个临时生成的入口，该入口下的所有文件都与小组关联。其对用户表现为url的路径。如果系统的网址是https://www.groupbin.com/，那么某个小组的链接为https://www.groupbin.com/xxx-xxx-xxx-xxx-xxx/，其中xxx-xxx-xxx-xxx-xxx为小组的id，是一个由系统生成的，难以枚举的字符串。

服务端后台可以选择设置一个统一密码，小组创建时可以选择自定义密码或者统一密码。此时创建界面上的“统一密码”选项的文字显示为“空密码（不安全）”，访问时不需要输入密码。如果使用统一密码的小组创建后，服务端修改了统一密码，那么新的访问也需要新的统一密码（如果改为空密码则不需要验证），但创建时设定为自定义密码的小组则不受影响。

密码鉴权需要在服务端设定延迟时间，一定程度上阻止密码穷举。

每一个小组具有有限期，默认为3天，在创建时可以通过选择菜单选择1小时、8小时、1天、7天、21天、30天，以及手动输入小时数量。不允许创建期限超过1个月的小组，但允许用户在使用过程中使用一个“刷新期限”的按钮，将使用期限重置为创建时的期限。在内部则统一使用小时为单位进行管理。

小组即是管理访问者的最小单位，没有用户名或者密码的概念。访问系统的凭证就是小组链接和密码。

一台机器上访问过的小组会被缓存在浏览器 cookies 中。如果一个用户直接访问不带路径的链接（主页），比如上面说过的https://www.groupbin.com/，那么该用户会进入小组选择页面，列出这个浏览器上所有访问过的小组，但进入有密码的小组，仍然需要输入密码。输入密码的有效期仅限于当前页面。小组选择页面同时应有新建小组的入口。此处，需要注意防止恶意攻击者通过构造 cookies 枚举可能存在的小组，最多只接受若干数量的小组id cookies缓存，这个数量默认10个，可以从服务端文件配置。超过这个数目后，最早的小组id cookies将被删除，即使上传到服务端也不做识别。

如果用户访问了不存在的小组，则返回一个自定义的404页面，其中包含一个返回主页的链接。

创建小组时，可以选择同时上传一些文件，在文件上传成功后才创建这个小组，并且可以选择该小组的文件为只读，这种情况下将禁止后续的上传和更新操作。只读小组一旦创建则不可更改，用户只能进行延期和下载操作。

用户可以选择打包所有文件，并下载一个zip文件。在打包时，多版本的文件使用同样的文件名，在文件名之前加`v-{可读时间戳}`标记，例如`v-01-01-00-00-00_{原文件名}.{原扩展名}`。

小组的页面上，应当包含如下内容：

+ 小组名称（创建时可选，为空则显示小组id）
+ 文件列表（每一个文件，以及对应的文件操作按钮）
+ 文件上传按钮
+ 小组剩余过期时间和刷新期限按钮
+ 打包下载所有文件

### 小组的只读属性

在小组创建时，有一个属性叫“允许转为只读”，在创建时选择。如果这个属性被勾选，那么在小组浏览界面，显示一个额外的按钮叫转为只读。一旦这个按钮被点击，则这个小组的只读属性被激活，小组成为只读，不允许删除和上传，同时不允许小组再次转为可写，即转换是一次性的。如果创建时没有选择“允许转为只读”，则小组将永远保持可写。

## 文件

一个文件是小组中的一个元素，用户可以上传、下载、更新文件。

上传大文件时，通过客户端操作允许用户无感分片上传，以便使得用户可以上传超过服务端最大post 数据量的文件。支持断点续传。

用户通过鉴权进入小组后，才能访问和编辑（加入不是只读）小组中的文件。

用户可以在非只读小组中上传文件，文件上传后，其他用户或者自己可以进行下载。上传文件时，可以选择改变文件名（默认使用磁盘上的文件名），以及可选的填写文件描述。

用户可以更新非只读小组中的文件，也就是上传文件的新版本。上传新版本时，需要填写文件更新注释，以及操作者（只是一个可选的文本字段，不验证），不允许更改文件名。
如果多次上传更新，则仅记录每一次更新的时间、注释、操作者，不保证版本之间的继承关系。对于有多个版本的文件，点击下载时不是直接下载，而是进入一个版本管理界面（弹窗），该界面列出所有版本，并允许用户选择下载某个版本。

每一个文件的操作界面应该包含如下功能按钮：
+ 下载
+ 版本管理（点击后进入版本管理界面）
+ 删除

每一个文件的显示区域应该包含文件名，以及最多显示额外一行的文件描述，显示不下的内容可以用省略号表示，点击展开。

小组内文件不得重名，不支持文件夹。

## 基于纯客户端 cookies 的已访问 group 列表记录

1. 用于记录访问过的group的体系完全在客户端执行，服务端不参与。创建group时不读取指纹也不在数据库中储存相关信息；
2. 使用一个存放有序列表的cookies，记录访问过的group的id、名字、描述和过期时间（UTC）；
3. 每次group页面被成功打开时，首先从浏览器的cookies中获取记录，看浏览器是否访问过这一group，如果已经访问过，将当前group对应的信息移动到cookies最前方；否则，则向获取的列表中加入当前group的相关信息（加入到最前方）。然后，如果列表的长度已经超过服务端预设的个数限制，则删去末尾的（最早写入的）条目；把修改过的cookies写入浏览器缓存中。这一方法保证缓存中只有有限个数的缓存，并且缓存的group的id是按照时间顺序排列的。
4. 每次打开主页时，服务端读取这个cookies列表，基于其中的条目，渲染已经访问的页面列表。这里不考虑相关的group是否存在、是否过期，也不检查密码。
5. 如果进入404界面或者过期界面，则删除当前的group所对应的cookies（如果存在）；
6. 相关操作所用的js脚本放在一个独立文件中，在需要的页面中引用。



## 服务端可配置项目

通过一个yml文件，可以从配置服务端一些功能。软件发布时，应该提供一份默认配置文件，用户可以自行修改。

+ 站点名字
+ 站点描述
+ 始终显示于页面底部的提示信息（需要较为醒目，因为可能需要放置一些保密提示信息）
+ 上传文件的最大大小（单位：MB，默认10MB）
+ 每个小组的最长有效期（单位：小时，默认72小时，用户不能设置更长的时间）
+ 过期文件清理期限（小组过期后开始计时）
+ 统一密码（默认为`danger-psw`）
+ 允许的最大小组ID cookies 缓存数目 （默认值10）
+ 文件储存根目录
+ 密码鉴权的延迟时间（默认2秒）

# 技术架构

1. 服务端使用 python + flask 框架
2. 数据库使用 sqlite
3. 文件存储使用本地文件系统，使用明文文件名，每个小组的文件保存在对应小组id的目录下，系统使用utf8编码存储和处理文件名
4. 使用响应式前端，兼容移动设备
